/**
 * Custom Measurements Logic for Abaya Store
 * Supports English (LTR) and Arabic (RTL)
 */
document.addEventListener('DOMContentLoaded', function() {
  const measurementWrapper = document.querySelector('.custom-measurements-wrapper');
  const addToCartForm = document.querySelector('form[action$="/cart/add"]');
  
  if (!measurementWrapper || !addToCartForm) return;

  // 1. FUNCTION: Toggle visibility based on size selection
  function toggleMeasurements() {
    // Look for the selected size radio button or dropdown value
    const selectedOption = addToCartForm.querySelector('input[name="options[Size]"]:checked, select[name="options[Size]"]');
    const selectedValue = selectedOption ? selectedOption.value.toLowerCase().trim() : '';

    // Check for "custom" in any language or the specific Arabic string from your screenshot
    if (selectedValue.includes('custom')) {
      measurementWrapper.style.display = 'block';
      measurementWrapper.classList.add('is-active');
    } else {
      measurementWrapper.style.display = 'none';
      measurementWrapper.classList.remove('is-active');
      clearErrors();
    }
  }

  // 2. EVENT: Listen for changes on size selectors
  addToCartForm.addEventListener('change', function(e) {
    if (e.target.name === 'options[Size]') {
      toggleMeasurements();
    }
  });

  // 3. VALIDATION: Check required fields on "Add to Cart"
  addToCartForm.addEventListener('submit', function(e) {
    if (measurementWrapper.classList.contains('is-active')) {
      const requiredInputs = measurementWrapper.querySelectorAll('input[required]');
      let hasError = false;

      requiredInputs.forEach(input => {
        if (!input.value.trim()) {
          input.style.border = '2px solid #ff0000';
          hasError = true;
        } else {
          input.style.border = '';
        }
      });

      if (hasError) {
        e.preventDefault();
        e.stopImmediatePropagation();
        
        // Show error message
        const errorMsg = measurementWrapper.querySelector('.measurements-error');
        if (errorMsg) errorMsg.style.display = 'flex';
        
        // Scroll to measurements
        measurementWrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  });

  function clearErrors() {
    const errorMsg = measurementWrapper.querySelector('.measurements-error');
    if (errorMsg) errorMsg.style.display = 'none';
    measurementWrapper.querySelectorAll('input').forEach(i => i.style.border = '');
  }

  // Run on page load
  toggleMeasurements();
});