{% comment %} 
  Find other products that share the first tag of the current product.
  You can change 'product.tags.first' to a specific tag like 'bestseller'
{% endcomment %}

{% assign relevant_tag = product.tags.first %}
{% if relevant_tag != blank %}
  {% assign counter = 0 %}
  {% assign max_products = 4 %}

  <h3>Other {{ relevant_tag }} products you might like:</h3>
  <div class="related-products-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
    {% for related_product in collections.all.products %}
      {% if related_product.tags contains relevant_tag and related_product.handle != product.handle %}
        <div class="product-card" style="border: 1px solid #e1e1e1; padding: 15px; border-radius: 8px;">
          <a href="{{ related_product.url }}" class="product-card__link">
            <div class="product-card__image" style="margin-bottom: 15px;">
              {% if related_product.featured_image %}
                <img 
                  src="{{ related_product.featured_image | img_url: '400x400' }}" 
                  alt="{{ related_product.featured_image.alt | escape }}" 
                  style="width: 100%; height: auto; display: block;"
                  loading="lazy"
                >
              {% else %}
                <div style="background: #f9f9f9; padding: 50px 0; text-align: center;">
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                </div>
              {% endif %}
            </div>
            
            <div class="product-card__info">
              <h4 class="product-card__title" style="margin: 0 0 10px 0; font-size: 16px;">
                {{ related_product.title }}
              </h4>
              
              <div class="product-card__price" style="margin-bottom: 10px;">
                {% if related_product.compare_at_price > related_product.price %}
                  <span class="price--sale" style="color: #d30000;">
                    <span class="visually-hidden">Sale price</span>
                    {{ related_product.price | money }}
                  </span>
                  <span class="price--compare" style="text-decoration: line-through; color: #999; margin-left: 8px;">
                    <span class="visually-hidden">Original price</span>
                    {{ related_product.compare_at_price | money }}
                  </span>
                {% else %}
                  <span class="price--regular">
                    {{ related_product.price | money }}
                  </span>
                {% endif %}
              </div>
              
              {% if related_product.available %}
                <span class="product-card__availability" style="color: #007b00;">In Stock</span>
              {% else %}
                <span class="product-card__availability" style="color: #dc3545;">Out of Stock</span>
              {% endif %}
            </div>
          </a>
        </div>
        
        {% assign counter = counter | plus: 1 %}
        {% if counter == max_products %}{% break %}{% endif %}
      {% endif %}
    {% endfor %}
    
    {% if counter == 0 %}
      <p>No related products found.</p>
    {% endif %}
  </div>
{% endif %}


{% schema %}
{
  "name": "Test Tag Section",
  "tag": "section",
  "presets": [
    {
      "name": "Test Tag Section",
      "category": "Custom Sections"
    }
  ]
}
{% endschema %}